---
import { getCollection } from 'astro:content';

interface Props {
  seriesId: string;
  currentSlug: string;
  position?: 'top' | 'bottom';
}

const { seriesId, currentSlug, position = 'top' } = Astro.props;

const allPosts = await getCollection('blog');
const seriesEntries = allPosts
  .filter((post) => post.data.seriesId === seriesId && !post.data.reference)
  .sort((a, b) => (a.data.part ?? Number.MAX_SAFE_INTEGER) - (b.data.part ?? Number.MAX_SAFE_INTEGER));

const current = seriesEntries.find((post) => post.slug === currentSlug);
const seriesTitle = current?.data.seriesTitle ?? seriesEntries[0]?.data.seriesTitle ?? 'Series';
const inferredTotal = Math.max(1, ...seriesEntries.map((post) => post.data.part ?? 0));
const totalParts = current?.data.totalParts ?? seriesEntries[0]?.data.totalParts ?? inferredTotal;
const partToEntry = new Map(seriesEntries.map((post) => [post.data.part, post] as const));

const parts = Array.from({ length: totalParts }, (_, index) => {
  const part = index + 1;
  const entry = partToEntry.get(part);
  const published = !!entry && !entry.data.draft;

  return { part, entry, published };
});

const publishedEntries = seriesEntries.filter((post) => !post.data.draft);
const currentIndex = publishedEntries.findIndex((post) => post.slug === currentSlug);
const prev = currentIndex > 0 ? publishedEntries[currentIndex - 1] : undefined;
const nextPublished =
  currentIndex >= 0 && currentIndex < publishedEntries.length - 1
    ? publishedEntries[currentIndex + 1]
    : undefined;

const nextPlanned = parts.find(
  (item) => item.part > (current?.data.part ?? 0) && (!item.entry || item.entry.data.draft),
);

const referencePost =
  allPosts.find((post) => post.data.seriesId === seriesId && post.data.reference && !post.data.draft) ??
  allPosts.find((post) => post.data.reference && !post.data.draft);

const showNav = seriesEntries.length > 0 && current;
---

{
  showNav && (
    <nav class={`series-nav series-nav--${position}`} aria-label="Series navigation">
      <div class="series-head">
        <p class="series-eyebrow">Series</p>
        <p class="series-title">{seriesTitle}</p>
        <p class="series-progress">
          Part {current?.data.part ?? '?'} of {totalParts}
        </p>
      </div>

      <div class="series-parts" role="list">
        {parts.map(({ part, entry, published }) => {
          const isCurrent = entry?.slug === currentSlug;
          const label = `Part ${part}`;
          const title = entry?.data.title ?? `${label} (coming soon)`;

          if (published && entry) {
            return (
              <a
                role="listitem"
                class:list={['series-chip', isCurrent && 'is-current']}
                href={`/blog/${entry.slug}/`}
                aria-current={isCurrent ? 'page' : undefined}
                title={title}
              >
                <span class="chip-label">{label}</span>
                <span class="chip-title">{title}</span>
              </a>
            );
          }

          return (
            <span role="listitem" class="series-chip is-coming-soon" title={title}>
              <span class="chip-label">{label}</span>
              <span class="chip-title">Coming soon</span>
            </span>
          );
        })}
      </div>

      <div class="series-foot">
        <div class="series-prev-next">
          {prev ? (
            <a class="series-link" href={`/blog/${prev.slug}/`}>← Previous</a>
          ) : (
            <span class="series-link is-muted">← Previous</span>
          )}
          {nextPublished ? (
            <a class="series-link" href={`/blog/${nextPublished.slug}/`}>Next →</a>
          ) : nextPlanned ? (
            <span class="series-link is-muted">Next: Part {nextPlanned.part} coming soon</span>
          ) : (
            <span class="series-link is-muted">Series complete</span>
          )}
        </div>

        {referencePost && (
          <a class="series-reference" href={`/blog/${referencePost.slug}/`}>
            Full reference edition
          </a>
        )}
      </div>
    </nav>
  )
}

<style>
  .series-nav {
    margin: 1rem 0 1.35rem;
    padding: 0.95rem 1rem;
    border-radius: 12px;
    background: linear-gradient(180deg, rgba(255, 248, 239, 0.86), rgba(255, 252, 246, 0.8));
    border: 1px solid rgba(78, 24, 26, 0.1);
  }

  .series-nav--bottom {
    margin-top: 1.65rem;
  }

  .series-head {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 0.2rem 0.7rem;
    align-items: end;
  }

  .series-eyebrow {
    margin: 0;
    font-family: var(--font-mono);
    font-size: 0.72rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: rgba(78, 24, 26, 0.8);
  }

  .series-title {
    margin: 0;
    font-family: var(--font-display);
    font-size: 1.02rem;
    color: var(--impala-brown-deep);
  }

  .series-progress {
    margin: 0;
    font-family: var(--font-mono);
    font-size: 0.78rem;
    color: rgba(16, 24, 40, 0.68);
    justify-self: end;
  }

  .series-parts {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 0.5rem;
    margin-top: 0.72rem;
  }

  .series-chip {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
    text-decoration: none;
    padding: 0.52rem 0.6rem;
    border-radius: 9px;
    background: rgba(255, 255, 255, 0.58);
    color: inherit;
    min-height: 58px;
  }

  .series-chip.is-current {
    background: rgba(34, 123, 251, 0.12);
  }

  .series-chip.is-coming-soon {
    background: rgba(16, 24, 40, 0.04);
  }

  .chip-label {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: rgba(16, 24, 40, 0.64);
  }

  .chip-title {
    font-size: 0.85rem;
    line-height: 1.25;
    color: rgba(16, 24, 40, 0.8);
  }

  .series-foot {
    display: flex;
    justify-content: space-between;
    gap: 0.8rem;
    align-items: center;
    flex-wrap: wrap;
    margin-top: 0.74rem;
  }

  .series-prev-next {
    display: inline-flex;
    gap: 0.8rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .series-link,
  .series-reference {
    font-size: 0.82rem;
    text-decoration: none;
    color: var(--accent);
  }

  .series-link.is-muted {
    color: rgba(16, 24, 40, 0.56);
  }

  .series-reference {
    font-family: var(--font-mono);
    font-size: 0.76rem;
    letter-spacing: 0.04em;
    color: rgba(78, 24, 26, 0.86);
  }

  @media (max-width: 780px) {
    .series-parts {
      grid-template-columns: 1fr;
    }

    .series-chip {
      min-height: 0;
    }
  }
</style>
